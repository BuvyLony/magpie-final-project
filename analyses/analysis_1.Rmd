---
title: "final project analysis script"
author: "Clara Matheis"
date: "28 7 2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
install

```

## read data
```{r}
all_data <- read.csv("./results_260_XPLab-2021-Group3_974857.csv")
glimpse(all_data)
```
# Cleaning data
```{r}
#select data to analyse 
analyse_data <- all_data[-c(3,4,6,7,9,10,17,20,21,22)]
#exclude data where understanding check was wrong
analyse_data <- analyse_data %>% 
  group_by(submission_id) %>% 
  filter(all( ( trial_name != "understanding_check" | ((response == "correct" & expected =="correct") | ( response == "incorrect" & expected == "incorrect")))))

# change ingroup norm
# analyse_data$ingroup_norm_new <- NA
# if(grepl("chose to call the police and report the robber.$",analyse_data$ingroup_norm)){
#   ingroup_norm_new = 0
# } else if(grepl("chose to do nothing and leave the robber alone.$",analyse_data$ingroup_norm)){
#   ingroup_norm_new = 1
# }
# 
# analyse_data$ingroup_norm_new <- ifelse((grepl("chose to do nothing and leave the robber alone.$",analyse_data$ingroup_norm)),1 ,0)

analyse_data %>%
  mutate(ingroup_norm_new = case_when(grepl("chose to do nothing and leave the robber alone.$",analyse_data$ingroup_norm) ~ "1",
                           grepl("chose to call the police and report the robber.$",analyse_data$ingroup_norm) ~ "0"))





# exclude questions of understanding check

analyse_data <- analyse_data[analyse_data$trial_name != "understanding_check", ]    
# new labels for better understanding
analyse_data <- mutate(analyse_data, condition = ifelse(grepl("chose to call the police and report the robber.$",analyse_data$ingroup_norm) & both_norms_shown ==0, "Ingroup norm favoured, call police, only ingroup norm shown",
                                                  ifelse(grepl("chose to do nothing and leave the robber alone.$",analyse_data$ingroup_norm) & both_norms_shown==0, "Ingroup norm favoured, leave robber alone, Only ingroup norm shown",
                                                         ifelse(grepl("chose to do nothing and leave the robber alone.$",analyse_data$ingroup_norm) & both_norms_shown==1, "Ingroup norm favoured, leaving robber alone, Both norms shown",
                                                                ifelse(grepl("chose to call the police and report the robber.$",analyse_data$ingroup_norm) & both_norms_shown ==1,"Ingroup norm favoured, calling the police, Both norms shown",
                                                                       NA)))))
```
# Analysis
```{r}
#Frequentist Analysis----------------
ordinal_1 <- clm(as.factor(response)~ingroup_norm*both_norms_shown, data=useable_data)

source("functions/produce_mean_and_count_bar_plot.R")
plot_1 <- produce_mean_and_count_bar_plot(useable_data, bar_width_means=0.5, bar_width_response=0.3)
ggsave(file="plot_1.png", plot=plot_1, width=190, height = 110, units="mm")  

#Bayesian analysis------------
#Prepare data for stan.
useable_data <- useable_data %>%
  select(expNum, response, ingroupNorm, bothShown, ingroupAgree, outgroupDisagree) %>% #select relevant columns
  mutate(ingroupAgree = ifelse(is.na(ingroupAgree), 1, ingroupAgree), #For the experiment we assumed that participants identified with the ingroup and not with the outgroup.
         outgroupDisagree = ifelse(is.na(outgroupDisagree), 1, outgroupDisagree)
         )
stan_data_all <- as.list(c(useable_data, N = dim(useable_data)[1]))
stan_data1 <- as.list(c(filter(useable_data), N=sum(useable_data)))
```

