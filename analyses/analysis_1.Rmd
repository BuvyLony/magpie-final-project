---
title: "final project analysis script"
author: "Clara Matheis"
date: "28 7 2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(ordinal)
library(StanHeaders)
library(rstan)
library(bridgesampling)
library(shiny)
library(shinystan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
set.seed(123)


```

## read data
```{r}
#--Set APA theme to use with ggplot
theme_set(theme_bw(18)+
            theme(panel.grid.major=element_blank(),
                  panel.grid.minor=element_blank(),
                  panel.border=element_blank(),
                  strip.background=element_blank(),
                  strip.text = element_text(face="bold"),
                  axis.line=element_line(),
                  text=element_text(family="serif")))

all_data <- read.csv("./results_260_XPLab-2021-Group3_974857.csv")
glimpse(all_data)
# total number of participants
n_participants_raw <- all_data %>% 
  group_by(submission_id) %>% 
  summarise() %>% 
  nrow(.)  
```
# Cleaning data
```{r}
#select data to analyse. drop columns endTime(5), experiment_id(10), startDate(21), startTime(22), timeSpent(23), trial_number(25)
analyse_data <- all_data[-c(5, 10, 21, 22, 23, 25)]
glimpse(analyse_data)
#exclude data where understanding check was wrong
analyse_data <- analyse_data %>% 
  group_by(submission_id) %>% 
  filter(all( ( trial_name != "understanding_check" | ((response_claim1 == "correct" &  response_claim2 == "incorrect" & response_claim3 == "incorrect" & response_claim4 == "incorrect")))))
# look how many were excluded bco understanding check
n_participants_raw - analyse_data %>% 
  group_by(submission_id) %>% 
  summarise() %>% 
  nrow(.)  

# change ingroup norm to 1 (do nothing) or 0 (call police)
analyse_data <- analyse_data %>%
  mutate(ingroup_norm_new = case_when(grepl("chose to do nothing and leave the robber alone.$",analyse_data$ingroup_norm) ~ 1,
                           grepl("chose to call the police and report the robber.$",analyse_data$ingroup_norm) ~ 0))





# exclude questions of understanding check

analyse_data <- analyse_data[analyse_data$trial_name != "understanding_check", ]    
# new labels for better understanding
analyse_data <- mutate(analyse_data, condition = ifelse(ingroup_norm_new ==0 & both_norms_shown ==0, "Ingroup norm favoured, call police, only ingroup norm shown",
                                                  ifelse(ingroup_norm_new ==1 & both_norms_shown==0, "Ingroup norm favoured, leave robber alone, only ingroup norm shown",
                                                         ifelse(ingroup_norm_new ==1 & both_norms_shown==1, "Ingroup norm favoured, leaving robber alone, both norms shown",
                                                                ifelse(ingroup_norm_new ==0 & both_norms_shown ==1,"Ingroup norm favoured, calling the police, both norms shown",
                                                                       NA)))))
# make wider

analyse_data <- pivot_wider(analyse_data,
    names_from = trial_name,
    values_from = response
  )
analyse_data <- analyse_data %>% 
  group_by(submission_id) %>%
    summarise_each(funs(toString(na.omit(.))))
    
#change response to moral dilemma
#def call the police = 1
# def not call the police = 6
for(i in 1:nrow(analyse_data)){
  if(analyse_data[i,"moral dilemma"] == "Definitely call the police and report the robber"){
  analyse_data[i,"moral dilemma"]<- 1
  } else if (analyse_data[i,"moral dilemma"] == "Very likely call the police and report the robber"){
  analyse_data[i,"moral dilemma"]<- 2
  } else if (analyse_data[i,"moral dilemma"] == "Probably call the police and report the robber"){
  analyse_data[i,"moral dilemma"]<- 3
  } else if (analyse_data[i,"moral dilemma"] == "Probably do nothing and the leave the robber alone"){
    analyse_data[i,"moral dilemma"]<- 4
  } else if (analyse_data[i,"moral dilemma"] == "Very likely do nothing and the leave the robber alone"){
    analyse_data[i,"moral dilemma"]<- 5
  } else if (analyse_data[i,"moral dilemma"] == "Definitely do nothing and leave the robber alone"){
    analyse_data[i,"moral dilemma"]<- 6
  }

}
# code ingroup pro and outgroup anti to 0 and 1
for(i in 1:nrow(analyse_data)){
  if(analyse_data[i,"identification_pro"] == 5 | analyse_data[i,"identification_pro"] == 6 | analyse_data[i,"identification_pro"] == 7){
  analyse_data[i,"identification_pro"]<- 1
  } else {
    analyse_data[i,"identification_pro"] <- 0 
  }

}
for(i in 1:nrow(analyse_data)){
  if(analyse_data[i,"identification_anti"] == 1 | analyse_data[i,"identification_anti"] == 2 | analyse_data[i,"identification_anti"] == 3){
  analyse_data[i,"identification_anti"]<- 1
  } else {
    analyse_data[i,"identification_anti"] <- 0 
  }

}




```
# Analysis
```{r}
# #Frequentist Analysis----------------
# length(analyse_data$ingroup_norm_new)
# length(analyse_data$both_norms_shown)
# 
# ordinal_1 <- clm(as.factor(analyse_data$`moral dilemma`)~ingroup_norm_new*both_norms_shown, data=analyse_data)
# 
# source("functions/produce_mean_and_count_bar_plot.R")
# plot_1 <- produce_mean_and_count_bar_plot(analyse_data, bar_width_means=0.5, bar_width_response=0.3)
# ggsave(file="plot_1.png", plot=plot_1, width=190, height = 110, units="mm")  

#Bayesian analysis------------
#Prepare data for stan.
analyse_data <- analyse_data %>%
  select(analyse_data$`moral dilemma`, ingroup_norm_new, both_norms_shown, identification_pro, identification_anti) %>% #select relevant columns
  mutate(identification_pro = ifelse(is.na(identification_pro), 1, identification_pro), #For the experiment we assumed that participants identified with the ingroup and not with the outgroup.
         identification_anti = ifelse(is.na(identification_anti), 1, identification_anti)
         )
stan_data_all <- as.list(c(analyse_data, N = dim(analyse_data)[1]))
stan_data1 <- as.list(c(filter(analyse_data), N=sum(analyse_data)))
```

